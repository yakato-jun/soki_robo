# 相補フィルタ

**前提知識**: エンコーダ（01/04）、IMU（01/05）、三角関数（02/01）

**目的**: 複数のセンサを混ぜて姿勢を推定する。確率なしでも動く手法。

---

## なぜセンサを混ぜるのか

1つのセンサには必ず弱点があります。

| センサ | 得意なこと | 弱点 |
| ------ | ---------- | ---- |
| ジャイロ（角速度） | 短期間の姿勢変化に正確 | 長時間使うとドリフトする |
| 加速度センサ | 重力方向が分かる（長期安定） | 振動やノイズに弱い |

- ジャイロだけ: 時間が経つほどズレる（ドリフト）
- 加速度だけ: 揺れるたびにガタガタ（ノイズ）

**短期はジャイロ、長期は加速度** を信じれば良い。
これを「混ぜる」のが相補フィルタです。

---

## 相補フィルタの仕組み

```
θ = α × (θ_prev + gyro × dt) + (1 - α) × accel_angle
```

- `θ_prev + gyro × dt` : ジャイロによる推定（積分）。短期で正確
- `accel_angle` : 加速度から求めた角度。長期で安定
- `α` : 混合比（0〜1）。例えば0.98

α = 0.98 なら:
- 98%はジャイロの推定を信じる（短期の正確さ）
- 2%は加速度の値で補正する（長期のドリフト防止）

### 加速度から角度を求める

ロボットが静止しているとき、加速度センサは重力だけを測ります。

```python
import numpy as np

# 加速度センサの値（静止時）
accel_x = 0.1   # ほぼ0
accel_z = 9.78   # ほぼ9.8（重力）

# 傾き角度
pitch = np.arctan2(accel_x, accel_z)
print(np.degrees(pitch))  # ≈ 0.6° （ほぼ水平）
```

`arctan2` — 三角関数のarctan が再登場します。

---

## numpyで実装

```python
import numpy as np

dt = 0.01    # 100Hz
alpha = 0.98  # 混合比

# 初期姿勢
theta = 0.0

# 記録用
history = []

# シミュレーション（仮のセンサデータ）
for k in range(1000):
    # ジャイロ（角速度）— 真値 + ドリフト + ノイズ
    true_rate = 0.5 * np.sin(k * dt * 2)  # 真の角速度
    gyro = true_rate + 0.01 + np.random.randn() * 0.1  # ドリフト+ノイズ

    # 加速度から求めた角度 — 真値 + ノイズ
    true_angle = -0.5 * np.cos(k * dt * 2) / 2
    accel_angle = true_angle + np.random.randn() * 0.3  # ノイズ多め

    # 相補フィルタ
    theta = alpha * (theta + gyro * dt) + (1 - alpha) * accel_angle

    history.append(theta)

# プロット
import matplotlib.pyplot as plt
time = np.arange(len(history)) * dt
plt.figure(figsize=(8, 4))
plt.plot(time, history, label='complementary filter')
plt.xlabel('time [s]')
plt.ylabel('angle [rad]')
plt.title('Complementary Filter')
plt.legend()
plt.grid(True)
plt.show()
```

---

## 遅れとの戦い

相補フィルタは **ローパスフィルタの一種** です。

- αが大きい → ジャイロ重視 → 応答は速いが、ドリフト残る
- αが小さい → 加速度重視 → ドリフトは消えるが、ノイズでガタつく

滑らかにすると遅れる。速く反応させるとノイズが入る。
このトレードオフは **確率なしでは根本的に解決できません**。

---

## 確率があるともっと良くなる

相補フィルタの α は固定値です。
「どのくらいジャイロを信じるか」を事前に人が決めています。

でも、状況によって信頼度は変わるはずです:
- ロボットが静止 → 加速度をもっと信じたい
- ロボットが加速中 → 加速度は重力以外の成分がある → ジャイロを信じたい

**信頼度を状況に応じて自動的に変える** のがカルマンフィルタです。
そのために確率（分散、ベイズ更新）が必要になります。

相補フィルタは「確率なしで動くフィルタ」。
カルマンフィルタは「確率を使ってもっと賢くなったフィルタ」。

---

## ここで覚えること

- 1つのセンサには必ず弱点がある
- 複数のセンサを混ぜると弱点を補い合える
- 相補フィルタ = 重み付き平均。確率なしでも動く
- ただし混合比は固定 → 状況変化に対応できない
- これを解決するのがカルマンフィルタ（確率を使った混合比の自動調整）

---

**次のレッスン**: → #28 モデルと状態方程式 (`03_engineering_computation/05_state_equation`)
