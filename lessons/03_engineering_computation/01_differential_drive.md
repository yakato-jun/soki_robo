# 差動二輪の運動学

**前提知識**: 三角関数（02/01）、線形代数（02/02）

**目的**: 行列で車輪速度と機体速度を変換する。学んだ道具の実践。

---

## 差動二輪ロボットとは

車輪が左右に2つ付いた台車型のロボットです。
今使っているYahboom MSPM0がまさにこれです。

- 左右の車輪速度を別々に制御できる
- 左右同じ速度 → 直進
- 左右で速度差 → カーブ / 旋回

03_wheel_control で体験したことを、ここでは数式で表します。

---

## 車輪速度 → 機体速度

左右の車輪速度 `[Vl, Vr]` から、機体の前進速度 `vx` と旋回角速度 `ωz` を求めます。

```
(vx )   ( 1/2   1/2 ) (Vl)
(   ) = (            ) (  )
(ωz )   (-1/L   1/L ) (Vr)
```

1文字で書くと: **ξ = J W**

- **ξ** = `[vx, ωz]` : 機体速度ベクトル
- **J** : 構造行列（ロボットの幾何構造を表す）
- **W** = `[Vl, Vr]` : 車輪速度ベクトル
- **L** : 車輪間の距離（トレッド幅）

### Jの意味

Jの中身を読み解くと:

- 1行目 `[1/2, 1/2]` → 前進速度は左右の平均
- 2行目 `[-1/L, 1/L]` → 旋回角速度は左右の差をLで割ったもの

Jはロボットの **構造そのもの** を表しています。
ロボットの車輪間の距離Lが変われば、Jの中身が変わります。

### numpyで計算

```python
import numpy as np

L = 0.15  # トレッド幅 [m]

J = np.array([[0.5,    0.5],
              [-1/L,   1/L]])

# 左右とも0.5 m/s → 直進
W = np.array([0.5, 0.5])
xi = J @ W
print(f"vx={xi[0]:.2f} m/s, ωz={xi[1]:.2f} rad/s")
# vx=0.50 m/s, ωz=0.00 rad/s ← 直進、回転なし

# 左0.3, 右0.5 → 左に曲がる
W = np.array([0.3, 0.5])
xi = J @ W
print(f"vx={xi[0]:.2f} m/s, ωz={xi[1]:.2f} rad/s")
# vx=0.40 m/s, ωz=1.33 rad/s ← 前進しつつ旋回
```

---

## 機体速度 → 車輪速度（逆変換）

「この前進速度と旋回角速度で動かしたい」→「左右の車輪を何m/sにすればいい？」

```
(Vl)   ( 1  -L/2 ) (vx)
(  ) = (         ) (  )
(Vr)   ( 1   L/2 ) (ωz)
```

**W = J⁻¹ ξ**

J⁻¹ は J の逆行列。「変換を元に戻す」操作です。

```python
J_inv = np.array([[1, -L/2],
                  [1,  L/2]])

# 前進0.5 m/s、旋回なし → 左右同じ速度
xi = np.array([0.5, 0.0])
W = J_inv @ xi
print(f"Vl={W[0]:.2f}, Vr={W[1]:.2f}")
# Vl=0.50, Vr=0.50

# 前進0.5 m/s、右旋回2.0 rad/s
xi = np.array([0.5, 2.0])
W = J_inv @ xi
print(f"Vl={W[0]:.2f}, Vr={W[1]:.2f}")
# Vl=0.35, Vr=0.65 ← 右を速くすると右に曲がる...?
```

> **注意**: 符号の取り方（どちら回りが正か）はロボットによって異なります。
> 実機で試して確認する必要があります。

---

## 「1文字で置く」の実践

この章全体で、Jという1文字が何度も出てきました。

- ξ = J W（車輪速度→機体速度）
- W = J⁻¹ ξ（機体速度→車輪速度）

Jの中身（1/2とか-1/Lとか）を毎回展開する必要はありませんでした。
**「Jは構造を表す」と分かっていれば、中身なしで思考が進む。**

これが線形代数で学んだ「1文字抽象化」の実践です。

---

## やってみよう

1. 自分のロボットのトレッド幅Lを測る
2. Jを作る
3. いろんな車輪速度を入れて、機体がどう動くか予測する
4. 実際にロボットを動かして、予測と合っているか確認する

「数式で予測 → 実機で確認」。これが工学のサイクルです。

---

**次のレッスン**: → #20 微積: 連続と離散 (`02_engineering_math/03_calculus`)
