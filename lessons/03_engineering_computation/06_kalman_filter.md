# カルマンフィルタ（概念）

**前提知識**: 確率（02/04）、相補フィルタ（03/04）、状態方程式（03/05）

**目的**: 予測と観測を信頼度で混ぜて推定を良くする仕組みを概念として理解する。

---

## すべてが合流する場所

ここまで学んできたものが、カルマンフィルタで合流します。

| 学んだこと | カルマンフィルタでの役割 |
| ---------- | ------------------------ |
| 線形代数（行列） | 状態の変換、予測、更新の計算 |
| 微積（dt） | 離散時間での状態更新 |
| 三角関数 | 座標変換（回転行列） |
| 確率（分散） | 信頼度の表現 |
| 確率（ベイズ更新） | 予測と観測の融合 |
| 状態方程式 | 予測ステップ |
| 相補フィルタ | カルマンフィルタの簡易版 |

---

## 相補フィルタの何が足りなかったか

相補フィルタ:

```
θ = α × (予測) + (1 - α) × (観測)
```

- α は固定値（0.98とか）
- 状況が変わっても混合比が変わらない

カルマンフィルタ:

```
x = K × (観測) + (1 - K) × (予測)
```

- **K（カルマンゲイン）は状況に応じて自動的に変わる**
- 予測が不確かなとき → Kが大きくなる → 観測を重視
- 観測が不確かなとき → Kが小さくなる → 予測を重視

「どちらをどれだけ信じるか」を **確率（分散）から自動計算** するのがカルマンフィルタの核心です。

---

## 2ステップの繰り返し

カルマンフィルタは2つのステップを繰り返すだけです。

### ステップ1: 予測（Predict）

状態方程式を使って「次はこうなるはず」を予測する。

```
x_pred = A × x + B × u        ← 状態の予測
P_pred = A × P × Aᵀ + Q       ← 不確かさの予測
```

- **x_pred**: 予測した状態
- **P_pred**: 予測の不確かさ（共分散行列）
- **Q**: プロセスノイズ（モデルがどれだけ不完全か）

モデルが不完全なので、予測するたびに不確かさが **増える**。

### ステップ2: 更新（Update）

センサの観測値で予測を補正する。

```
K = P_pred × Hᵀ × (H × P_pred × Hᵀ + R)⁻¹  ← カルマンゲイン
x = x_pred + K × (z - H × x_pred)              ← 状態の更新
P = (I - K × H) × P_pred                        ← 不確かさの更新
```

- **z**: センサの観測値
- **H**: 観測行列（「状態のうち何が見えるか」）
- **R**: 観測ノイズ（センサがどれだけ不正確か）
- **K**: カルマンゲイン（混合比。自動計算される）

観測で補正するたびに不確かさが **減る**。

### サイクル

```
予測 → 不確かさ増える → 観測で補正 → 不確かさ減る → 予測 → ...
```

この繰り返しで、推定がどんどん良くなっていきます。

---

## 確率の道具がすべて使われている

大枠2の確率で学んだ概念がここで全部出てきます。

- **分散（P, Q, R）**: 信頼度の表現
- **ベイズ更新**: 事前推定（予測）× 観測の尤もらしさ → 事後推定（更新）
- **マルコフ性**: 直前の状態だけで次を予測
- **フュージョン**: 予測と観測を信頼度で混ぜる
- **尤度**: 「この観測値が出るなら、この状態がどれだけ尤もらしいか」

---

## 概念の理解が目標

数式を全部理解する必要はありません。

理解してほしいのは:

1. **予測と観測の2ステップを繰り返す**
2. **どちらをどれだけ信じるかを確率（分散）で自動計算する**
3. **モデルが不完全 → 予測の不確かさが増える → 観測で補正**
4. **相補フィルタの発展版。混合比が固定→自動**

実装は進学後に、大学で理論を学んだうえで取り組みます。

---

## ここまでの旅路

振り返ると:

1. **車輪を回した**（体験）→ 「どれだけ動いたか知りたい」
2. **エンコーダを読んだ**（体験）→ 「累積するとズレる」
3. **三角関数・線形代数・微積を学んだ**（道具）→ 計算の仕組み
4. **差動二輪の運動学を計算した**（応用）→ 行列の実践
5. **オドメトリで破綻した**（応用）→ 「1つのセンサでは限界がある」
6. **PIDで暴れさせた**（応用）→ 「理論通りでも壊れる」
7. **確率を学んだ**（道具）→ 不確かさの扱い方
8. **相補フィルタで混ぜた**（応用）→ 「確率があればもっと良くなるはず」
9. **状態方程式を作った**（応用）→ 未来が予測できる
10. **カルマンフィルタ**（応用）→ **すべてが合流**

「ロボットを触って、道具を学んで、道具を使って、壊れて、また学んで」。
このサイクルの到達点がカルマンフィルタです。

---

> **大枠3全体を通じて**: ここでやった内容は大学の3年次〜研究室配属レベルです。
> 全部分からなくても「名前を聞いたことがある」「概念のイメージがある」だけで、
> 大学の授業や研究室で「ああ、あの話か」と繋がります。
>
> 研究室の先輩から見ると、**「この下地がある後輩は教えやすい」** 構成になっています。

---

**レッスン完了。** おつかれさまでした。
ここから先は大学での学びと合わせて、継続サポートで深めていきます。
